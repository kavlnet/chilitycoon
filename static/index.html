<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chili Tycoon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aldrich&family=VT323:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="intro-screen" class="intro-screen">
        <img src="/intro_image.png" alt="Chili Tycoon" class="intro-image">
        <button id="start-intro-btn" class="btn btn-primary btn-pulse">PRESS START</button>
    </div>

    <div class="container" id="main-container" style="display: none;">
        <header>
            <h1>üå∂Ô∏è CHILI TYCOON üå∂Ô∏è</h1>
            <p class="tagline">Read the market. Build your empire.</p>
        </header>

        <main class="start-flow">
            <section class="join-form identity-form">
                <h2>1. Your Identity</h2>
                <p class="hint">Player name is shared across Multiplayer and Solo.</p>
                <div class="form-group">
                    <label for="player-name">Player Name</label>
                    <input type="text" id="player-name" placeholder="Enter your name" maxlength="20">
                </div>
            </section>

            <section class="join-form mode-picker">
                <h2>2. Select Mode</h2>
                <div class="mode-tabs">
                    <button id="mode-multiplayer-btn" class="btn btn-secondary mode-tab active" type="button">Multiplayer</button>
                    <button id="mode-solo-btn" class="btn btn-secondary mode-tab" type="button">Solo Run</button>
                </div>
                <p id="mode-subtitle" class="hint mode-subtitle">Join friends in a shared room or host your own lobby.</p>
            </section>

            <section id="multiplayer-panel" class="join-form mode-panel">
                <h2>3A. Multiplayer Lobby</h2>
                <div class="mode-columns">
                    <div class="mode-subcard">
                        <h3>Create Room</h3>
                        <p class="hint">Host controls start/pause/reset and can add bots.</p>
                        <button id="create-room-btn" class="btn btn-primary">Create Room</button>
                        <div id="room-created" class="room-created hidden">
                            <div class="room-code">Room Code: <span id="room-code"></span></div>
                            <div class="room-actions">
                                <a id="host-link" class="btn btn-secondary" href="#">Open Host Dashboard</a>
                                <button id="copy-room-btn" class="btn btn-primary">Copy Room Link</button>
                            </div>
                            <p class="hint">Share the room code or link with players.</p>
                        </div>
                    </div>

                    <div class="mode-subcard">
                        <h3>Join Room</h3>
                        <div class="form-group">
                            <label for="room-id">Room Code</label>
                            <input type="text" id="room-id" placeholder="Enter room code" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="team-name">Team Name</label>
                            <input type="text" id="team-name" placeholder="Enter team name" maxlength="20" list="team-options">
                            <datalist id="team-options"></datalist>
                            <div id="team-status" class="team-status">Enter a room code, then pick or create a team.</div>
                        </div>
                        <div class="mode-actions">
                            <button id="join-btn" class="btn btn-primary" type="button">Join Game</button>
                            <button id="spectate-btn" class="btn btn-secondary" type="button">Spectate</button>
                        </div>
                    </div>
                </div>

                <div class="teams-list">
                    <h3>Current Teams</h3>
                    <div id="teams-container">
                        <p class="empty-state">Enter a room code to see teams.</p>
                    </div>
                </div>
            </section>

            <section id="solo-panel" class="join-form solo-form mode-panel hidden">
                <h2>3B. Solo Setup</h2>
                <p class="hint">No host required. Solo run starts automatically after you connect.</p>
                <div class="form-group">
                    <label for="solo-team-name">Solo Team Banner (optional)</label>
                    <input type="text" id="solo-team-name" placeholder="Auto: your name + Solo" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="solo-difficulty">Difficulty</label>
                    <select id="solo-difficulty">
                        <option value="chill">Chill</option>
                        <option value="standard" selected>Standard</option>
                        <option value="hard">Hard</option>
                        <option value="expert">Expert</option>
                    </select>
                </div>
                <label class="solo-toggle">
                    <input type="checkbox" id="solo-daily">
                    Daily Challenge (seeded market + mutators)
                </label>
                <button id="solo-start-btn" class="btn btn-primary" type="button">Start Solo Run</button>
            </section>

            <section class="rules">
                <h3>How to Play</h3>
                <ul>
                    <li><strong>Vote as a team</strong> - Majority locks in your attribute choice</li>
                    <li><strong>Beat the market standard</strong> - Weighted score must exceed the benchmark</li>
                    <li><strong>Learn from feedback</strong> - Customer reviews hide what matters most</li>
                    <li><strong>Speed = leverage</strong> - Fast correct decisions build more</li>
                </ul>

                <h4>Key Mechanics</h4>
                <ul>
                    <li>Weights drift in regimes - read the pattern, then move fast</li>
                    <li>Bars depreciate each round - keep investing</li>
                    <li>Paradigm shift adds a new attribute mid-game</li>
                </ul>
            </section>
        </main>
    </div>

    <script>
        const STORAGE = {
            roomId: 'chili_roomId',
            hostKey: 'chili_hostKey',
            playerName: 'chili_playerName',
            playerId: 'chili_playerId',
            activeTeam: 'chili_teamName',
            multiplayerTeam: 'chili_teamName_multi',
            soloTeam: 'chili_teamName_solo',
            lastMode: 'chili_mode_last',
        };

        const roomInput = document.getElementById('room-id');
        const teamInput = document.getElementById('team-name');
        const soloTeamInput = document.getElementById('solo-team-name');
        const nameInput = document.getElementById('player-name');
        const modeMultiplayerBtn = document.getElementById('mode-multiplayer-btn');
        const modeSoloBtn = document.getElementById('mode-solo-btn');
        const modeSubtitle = document.getElementById('mode-subtitle');
        const multiplayerPanel = document.getElementById('multiplayer-panel');
        const soloPanel = document.getElementById('solo-panel');
        const joinBtn = document.getElementById('join-btn');
        const spectateBtn = document.getElementById('spectate-btn');
        const soloStartBtn = document.getElementById('solo-start-btn');
        const soloDifficultyInput = document.getElementById('solo-difficulty');
        const soloDailyInput = document.getElementById('solo-daily');
        const teamsContainer = document.getElementById('teams-container');
        const teamStatus = document.getElementById('team-status');
        const teamOptions = document.getElementById('team-options');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomCreated = document.getElementById('room-created');
        const roomCodeEl = document.getElementById('room-code');
        const hostLink = document.getElementById('host-link');
        const copyRoomBtn = document.getElementById('copy-room-btn');

        let activeMode = 'multiplayer';
        let currentTeams = [];

        function setStored(key, value) {
            localStorage.setItem(key, value);
        }

        function getStored(key) {
            return localStorage.getItem(key);
        }

        function getOrCreatePlayerId(roomId) {
            const existing = getStored(STORAGE.playerId);
            const existingRoom = getStored(STORAGE.roomId);
            if (existing && existingRoom === roomId) {
                return existing;
            }
            const id = 'p_' + Math.random().toString(36).slice(2, 10);
            setStored(STORAGE.playerId, id);
            return id;
        }

        function normalizeTeamName(name) {
            return name.toLowerCase().replace(/\s+/g, ' ').trim();
        }

        function findExactTeamMatch(input) {
            const normalized = normalizeTeamName(input);
            if (!normalized) return null;
            return currentTeams.find(team => normalizeTeamName(team) === normalized) || null;
        }

        function setMode(mode) {
            activeMode = mode === 'solo' ? 'solo' : 'multiplayer';
            const multiplayerActive = activeMode === 'multiplayer';
            modeMultiplayerBtn.classList.toggle('active', multiplayerActive);
            modeSoloBtn.classList.toggle('active', !multiplayerActive);
            multiplayerPanel.classList.toggle('hidden', !multiplayerActive);
            soloPanel.classList.toggle('hidden', multiplayerActive);
            modeSubtitle.textContent = multiplayerActive
                ? 'Join friends in a shared room or host your own lobby.'
                : 'Instant AI run with objectives, mutators, and end-of-run grade.';
            setStored(STORAGE.lastMode, activeMode);
        }

        function requirePlayerName() {
            const playerName = nameInput.value.trim();
            if (!playerName) {
                alert('Enter your player name first.');
                nameInput.focus();
                return null;
            }
            setStored(STORAGE.playerName, playerName);
            return playerName;
        }

        function getDefaultSoloTeamName(playerName) {
            return `${playerName} Solo`.trim().slice(0, 20);
        }

        function refreshSoloTeamPlaceholder() {
            const playerName = nameInput.value.trim();
            if (!soloTeamInput) return;
            soloTeamInput.placeholder = playerName
                ? `Auto: ${getDefaultSoloTeamName(playerName)}`
                : 'Auto: your name + Solo';
        }

        function updateTeamStatus() {
            const roomId = roomInput.value.trim();
            const input = teamInput.value.trim();
            const match = findExactTeamMatch(input);
            if (!roomId) {
                teamStatus.textContent = 'Enter a room code, then pick or create a team.';
                joinBtn.textContent = 'Join Game';
            } else if (!input) {
                teamStatus.textContent = 'Select a team below or type a new name.';
                joinBtn.textContent = 'Join Game';
            } else if (match) {
                teamStatus.textContent = `Joining team: ${match}`;
                joinBtn.textContent = 'Join Team';
            } else {
                teamStatus.textContent = 'No matching team ‚Äî this will create a new team.';
                joinBtn.textContent = 'Create Team';
            }
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.toggle('selected', match && card.dataset.team === match);
            });
        }

        async function loadTeams(roomId) {
            if (!roomId) {
                teamsContainer.innerHTML = '<p class="empty-state">Enter a room code to see teams.</p>';
                currentTeams = [];
                if (teamOptions) teamOptions.innerHTML = '';
                updateTeamStatus();
                return;
            }
            try {
                const response = await fetch(`/api/room/${encodeURIComponent(roomId)}/teams`);
                if (!response.ok) throw new Error('Failed');
                const data = await response.json();
                currentTeams = (data.teams || []).map(team => team.name);
                if (teamOptions) {
                    teamOptions.innerHTML = currentTeams.map(name => `<option value="${name}"></option>`).join('');
                }
                if (!data.teams || data.teams.length === 0) {
                    teamsContainer.innerHTML = '<p class="empty-state">No teams yet. Create one!</p>';
                } else {
                    teamsContainer.innerHTML = data.teams.map(team => `
                        <div class="team-card" data-team="${team.name}">
                            <span class="team-name">${team.name}</span>
                            <span class="team-info">${team.players} players | $${team.cash}</span>
                        </div>
                    `).join('');
                    teamsContainer.querySelectorAll('.team-card').forEach(card => {
                        card.addEventListener('click', () => selectTeam(card.dataset.team));
                    });
                }
                updateTeamStatus();
            } catch (err) {
                teamsContainer.innerHTML = '<p class="empty-state">Room not found yet.</p>';
                currentTeams = [];
                if (teamOptions) teamOptions.innerHTML = '';
                updateTeamStatus();
            }
        }

        function selectTeam(name) {
            teamInput.value = name;
            updateTeamStatus();
        }
        window.selectTeam = selectTeam;

        createRoomBtn.addEventListener('click', async () => {
            createRoomBtn.disabled = true;
            createRoomBtn.textContent = 'Creating...';
            try {
                const response = await fetch('/api/room', { method: 'POST' });
                const data = await response.json();
                roomCodeEl.textContent = data.roomId;
                roomCreated.classList.remove('hidden');
                hostLink.href = `/host.html?room=${data.roomId}&hostKey=${data.hostKey}`;

                setStored(STORAGE.roomId, data.roomId);
                setStored(STORAGE.hostKey, data.hostKey);
                roomInput.value = data.roomId;
                setMode('multiplayer');
                loadTeams(data.roomId);
            } catch (err) {
                alert('Failed to create room.');
            } finally {
                createRoomBtn.disabled = false;
                createRoomBtn.textContent = 'Create Room';
            }
        });

        copyRoomBtn.addEventListener('click', () => {
            const roomId = roomCodeEl.textContent;
            if (!roomId) return;
            const link = `${window.location.origin}/?room=${roomId}`;
            navigator.clipboard.writeText(link).then(() => {
                copyRoomBtn.textContent = 'Copied!';
                setTimeout(() => (copyRoomBtn.textContent = 'Copy Room Link'), 1500);
            });
        });

        joinBtn.addEventListener('click', () => {
            const playerName = requirePlayerName();
            if (!playerName) return;
            const roomId = roomInput.value.trim();
            const teamNameInput = teamInput.value.trim();
            if (!roomId || !teamNameInput) {
                alert('Please enter room code and team name.');
                return;
            }
            const matchedTeam = findExactTeamMatch(teamNameInput);
            if (!matchedTeam && currentTeams.length > 0) {
                const ok = confirm(`No matching team found. Create new team "${teamNameInput}"?`);
                if (!ok) return;
            }
            const teamName = matchedTeam || teamNameInput;
            const playerId = getOrCreatePlayerId(roomId);
            setStored(STORAGE.roomId, roomId);
            setStored(STORAGE.activeTeam, teamName);
            setStored(STORAGE.multiplayerTeam, teamName);
            setStored(STORAGE.playerName, playerName);
            setStored(STORAGE.playerId, playerId);
            setStored(STORAGE.lastMode, 'multiplayer');
            window.location.href = `/game.html?room=${encodeURIComponent(roomId)}`;
        });

        spectateBtn.addEventListener('click', () => {
            const roomId = roomInput.value.trim();
            if (!roomId) {
                alert('Enter a room code to spectate.');
                return;
            }
            window.location.href = `/spectate.html?room=${encodeURIComponent(roomId)}`;
        });

        if (soloStartBtn) {
            soloStartBtn.addEventListener('click', async () => {
                const playerName = requirePlayerName();
                if (!playerName) return;

                const rawTeamName = soloTeamInput?.value.trim();
                const desiredTeamName = (rawTeamName || getDefaultSoloTeamName(playerName)).slice(0, 20);
                const payload = {
                    difficulty: soloDifficultyInput?.value || 'standard',
                    daily: Boolean(soloDailyInput?.checked),
                    playerTeam: desiredTeamName,
                };

                soloStartBtn.disabled = true;
                soloStartBtn.textContent = 'Creating Run...';
                try {
                    const response = await fetch('/api/room/solo', {
                        method: 'POST',
                        headers: { 'content-type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) throw new Error('Failed solo setup');
                    const data = await response.json();
                    const teamName = data.playerTeam || desiredTeamName;
                    const playerId = getOrCreatePlayerId(data.roomId);

                    setStored(STORAGE.roomId, data.roomId);
                    setStored(STORAGE.hostKey, data.hostKey);
                    setStored(STORAGE.activeTeam, teamName);
                    setStored(STORAGE.soloTeam, teamName);
                    setStored(STORAGE.playerName, playerName);
                    setStored(STORAGE.playerId, playerId);
                    setStored(STORAGE.lastMode, 'solo');

                    window.location.href = `/game.html?room=${encodeURIComponent(data.roomId)}`;
                } catch (err) {
                    alert('Failed to start solo run.');
                } finally {
                    soloStartBtn.disabled = false;
                    soloStartBtn.textContent = 'Start Solo Run';
                }
            });
        }

        modeMultiplayerBtn.addEventListener('click', () => setMode('multiplayer'));
        modeSoloBtn.addEventListener('click', () => setMode('solo'));
        roomInput.addEventListener('input', () => {
            loadTeams(roomInput.value.trim());
        });
        teamInput.addEventListener('input', updateTeamStatus);
        nameInput.addEventListener('input', () => {
            refreshSoloTeamPlaceholder();
            setStored(STORAGE.playerName, nameInput.value.trim());
        });
        if (soloTeamInput) {
            soloTeamInput.addEventListener('input', () => {
                setStored(STORAGE.soloTeam, soloTeamInput.value.trim());
            });
        }

        const params = new URLSearchParams(window.location.search);
        const presetRoom = params.get('room');
        if (presetRoom) {
            roomInput.value = presetRoom.toUpperCase();
            loadTeams(roomInput.value.trim());
        }

        const storedRoom = getStored(STORAGE.roomId);
        if (storedRoom && !roomInput.value) {
            roomInput.value = storedRoom;
            loadTeams(storedRoom);
        }
        const storedTeam = getStored(STORAGE.multiplayerTeam) || getStored(STORAGE.activeTeam);
        if (storedTeam) teamInput.value = storedTeam;
        const storedSoloTeam = getStored(STORAGE.soloTeam);
        if (storedSoloTeam && soloTeamInput) soloTeamInput.value = storedSoloTeam;
        const storedName = getStored(STORAGE.playerName);
        if (storedName) nameInput.value = storedName;
        const lastMode = getStored(STORAGE.lastMode);
        const initialMode = presetRoom ? 'multiplayer' : (lastMode === 'solo' ? 'solo' : 'multiplayer');
        setMode(initialMode);
        refreshSoloTeamPlaceholder();
        updateTeamStatus();

        setInterval(() => {
            const roomId = roomInput.value.trim();
            if (activeMode === 'multiplayer' && roomId) loadTeams(roomId);
        }, 4000);

        document.getElementById('start-intro-btn').addEventListener('click', () => {
            document.getElementById('intro-screen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
            }, 500);
        });
        document.getElementById('intro-screen').addEventListener('click', () => {
            document.getElementById('start-intro-btn').click();
        });
        document.addEventListener('keydown', () => {
            if (document.getElementById('intro-screen').style.display !== 'none') {
                document.getElementById('start-intro-btn').click();
            }
        }, { once: true });
    </script>
</body>
</html>
